<?php
/*
 * @ https://github.com/CMSNTSourceCode
 * @ Meo Mat Cang
 * @ PHP 7.4
 * @ Telegram : @Mo_Ho_Bo
 */
if(!defined("IN_SITE")) {
    exit("The Request Not Found");
}
$body = ["title" => __("Categories") . " | " . $CMSNT->site("title"), "desc" => $CMSNT->site("description"), "keyword" => $CMSNT->site("keywords")];
$body["header"] = "\n\n \n";
$body["footer"] = "\n\n\n<!-- Page JS Plugins -->\n \n\n";
require_once __DIR__ . "/../../models/is_admin.php";
require_once __DIR__ . "/header.php";
require_once __DIR__ . "/sidebar.php";
if(!checkPermission($getUser["admin"], "view_product")) {
    exit("<script type=\"text/javascript\">if(!alert(\"Bạn không có quyền sử dụng tính năng này\")){window.history.back();}</script>");
}
if(isset($_POST["submit"])) {
    if($CMSNT->site("status_demo") != 0) {
        exit("<script type=\"text/javascript\">if(!alert(\"Không được dùng chức năng này vì đây là trang web demo.\")){window.history.back().location.reload();}</script>");
    }
    if(!checkPermission($getUser["admin"], "edit_product")) {
        exit("<script type=\"text/javascript\">if(!alert(\"Bạn không có quyền sử dụng tính năng này\")){window.history.back();}</script>");
    }
    if($CMSNT->get_row("SELECT * FROM `categories` WHERE `slug` = '" . create_slug(check_string($_POST["name"])) . "' ")) {
        exit("<script type=\"text/javascript\">if(!alert(\"Chuyên mục này đã tồn tại trong hệ thống.\")){window.history.back().location.reload();}</script>");
    }
    $url_icon = NULL;
    if(check_img("icon")) {
        $rand = random("0123456789QWERTYUIOPASDGHJKLZXCVBNM", 4);
        $uploads_dir = "assets/storage/images/icon" . $rand . ".png";
        $tmp_name = $_FILES["icon"]["tmp_name"];
        $addlogo = move_uploaded_file($tmp_name, $uploads_dir);
        if($addlogo) {
            $url_icon = $uploads_dir;
        }
    }
    $isInsert = $CMSNT->insert("categories", ["stt" => check_string($_POST["stt"]), "icon" => $url_icon, "name" => check_string($_POST["name"]), "parent_id" => check_string($_POST["parent_id"]), "slug" => create_slug(check_string($_POST["name"])), "description" => check_string($_POST["description"]), "status" => check_string($_POST["status"]), "create_date" => gettime()]);
    if($isInsert) {
        $Mobile_Detect = new Mobile_Detect();
        $CMSNT->insert("logs", ["user_id" => $getUser["id"], "ip" => myip(), "device" => $Mobile_Detect->getUserAgent(), "createdate" => gettime(), "action" => "Add Category (" . check_string($_POST["name"]) . ")."]);
        $my_text = $CMSNT->site("noti_action");
        $my_text = str_replace("{domain}", $_SERVER["SERVER_NAME"], $my_text);
        $my_text = str_replace("{username}", $getUser["username"], $my_text);
        $my_text = str_replace("{action}", "Add Category (" . check_string($_POST["name"]) . ").", $my_text);
        $my_text = str_replace("{ip}", myip(), $my_text);
        $my_text = str_replace("{time}", gettime(), $my_text);
        sendMessAdmin($my_text);
        exit("<script type=\"text/javascript\">if(!alert(\"Thêm thành công !\")){location.href = \"\";}</script>");
    }
    exit("<script type=\"text/javascript\">if(!alert(\"Thêm thất bại !\")){window.history.back().location.reload();}</script>");
}
echo "\n\n<div class=\"main-content app-content\">\n    <div class=\"container-fluid\">\n        <!-- Tiêu đề trang -->\n        <div class=\"d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb\">\n            <h1 class=\"page-name fw-semibold fs-18 mb-0\">\n                <i class=\"fa-solid fa-sitemap me-1\"></i> Quản lý chuyên mục sản phẩm\n            </h1>\n            <div class=\"ms-md-1 ms-0\">\n                <button id=\"btn-add-parent\" class=\"btn btn-primary btn-sm\">\n                    <i class=\"fa-solid fa-plus me-1\"></i>Thêm chuyên mục cha\n                </button>\n            </div>\n        </div>\n\n        <div class=\"row\">\n            <!-- Form thêm chuyên mục cha -->\n            <div class=\"col-xl-12\" id=\"card-add-parent\" style=\"display: none;\">\n                <div class=\"card custom-card mb-4\">\n                    <div class=\"card-header d-flex justify-content-between border-bottom-0\">\n                        <div class=\"card-title\">\n                            <i class=\"fa-solid fa-folder-plus me-2\"></i>Thêm chuyên mục cha mới\n                        </div>\n                        <button type=\"button\" class=\"btn-close\" id=\"btn-close-add-parent\"></button>\n                    </div>\n                    <div class=\"card-body\">\n                        <form action=\"\" method=\"POST\" enctype=\"multipart/form-data\">\n                            <div class=\"row\">\n                                <div class=\"col-md-6\">\n                                    <div class=\"mb-3\">\n                                        <label class=\"form-label\" for=\"stt\">";
echo __("Ưu tiên:");
echo "</label>\n                                        <input type=\"text\" class=\"form-control\" value=\"0\" name=\"stt\" required>\n                                        <div class=\"form-text text-muted\">Ưu tiên càng cao, chuyên mục càng hiển thị trên cùng</div>\n                                    </div>\n                                    <div class=\"mb-3\">\n                                        <label class=\"form-label\">";
echo __("Tên chuyên mục cha:");
echo " <span class=\"text-danger\">*</span></label>\n                                        <input type=\"text\" class=\"form-control\" name=\"name\" placeholder=\"";
echo __("Nhập tên chuyên mục");
echo "\" required>\n                                    </div>\n                                    <input type=\"hidden\" name=\"parent_id\" value=\"0\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <div class=\"mb-3\">\n                                        <label class=\"form-label\">";
echo __("Icon:");
echo " <span class=\"text-danger\">*</span></label>\n                                        <input type=\"file\" class=\"form-control\" name=\"icon\" required>\n                                    </div>\n                                    <div class=\"mb-3\">\n                                        <label class=\"form-label\">";
echo __("Trạng thái:");
echo " <span class=\"text-danger\">*</span></label>\n                                        <select class=\"form-select\" name=\"status\" required>\n                                            <option value=\"1\">Hiển thị</option>\n                                            <option value=\"0\">Ẩn</option>\n                                        </select>\n                                    </div>\n                                </div>\n                                <div class=\"col-md-12\">\n                                    <div class=\"mb-3\">\n                                        <label class=\"form-label\">";
echo __("Description SEO:");
echo "</label>\n                                        <textarea class=\"form-control\" rows=\"3\" name=\"description\" placeholder=\"Mô tả ngắn về chuyên mục này\"></textarea>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"d-flex justify-content-end mt-3\">\n                                <button type=\"submit\" name=\"submit\" class=\"btn btn-primary\">\n                                    <i class=\"fa-solid fa-save me-1\"></i> ";
echo __("Thêm chuyên mục");
echo "                                </button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Danh sách chuyên mục -->\n            <div class=\"col-xl-12\">\n                <div class=\"card custom-card\">\n                    <div class=\"card-header border-bottom d-flex justify-content-between align-items-center\">\n                        <h6 class=\"card-title mb-0\"><i class=\"fa-solid fa-list-ul me-2\"></i>DANH SÁCH CHUYÊN MỤC SẢN PHẨM</h6>\n                        <div>\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" id=\"collapse-all-btn\">\n                                <i class=\"fa-solid fa-angles-up me-1\"></i> Đóng tất cả\n                            </button>\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" id=\"expand-all-btn\">\n                                <i class=\"fa-solid fa-angles-down me-1\"></i> Mở tất cả\n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"card-body\">\n                        ";
$parentCategories = $CMSNT->get_list("SELECT * FROM `categories` WHERE `parent_id` = 0 ORDER BY `stt` DESC");
if(0 < count($parentCategories)) {
    echo "                        <style>\n                            .sortable-parent-item {\n                                cursor: pointer;\n                                margin-bottom: 10px;\n                                border: 1px solid #e9e9e9;\n                                background-color: #fff;\n                                border-radius: 8px;\n                                overflow: hidden;\n                                box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n                            }\n                            .handle-parent {\n                                cursor: move !important;\n                                padding: 8px;\n                                font-size: 18px;\n                                color: #757575;\n                                display: inline-block;\n                                margin-right: 5px;\n                                background-color: #f5f5f5;\n                                border-radius: 4px;\n                            }\n                            .handle-parent:hover {\n                                color: #0d6efd;\n                                background-color: #e9ecef;\n                            }\n                            .ui-sortable-helper {\n                                box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);\n                                background-color: #f8f9fa;\n                                transform: scale(1.02);\n                                transition: all 0.2s;\n                            }\n                            .ui-state-highlight {\n                                height: 60px;\n                                background-color: #fffde7;\n                                border: 1px dashed #ffc107;\n                                margin-bottom: 10px;\n                                border-radius: 8px;\n                            }\n                            .category-header {\n                                padding: 12px !important;\n                                background: linear-gradient(to right, #f8f9fa, #ffffff) !important;\n                                border-bottom: 1px solid #e9ecef;\n                            }\n                            .category-name1 {\n                                font-size: 16px;\n                                font-weight: 600;\n                                margin: 0;\n                                white-space: nowrap;\n                                overflow: hidden;\n                                text-overflow: ellipsis;\n                                max-width: 180px;\n                            }\n                            .category-badge {\n                                font-size: 11px;\n                                padding: 4px 8px;\n                            }\n                            .category-actions {\n                                margin-top: 10px;\n                                display: flex;\n                                flex-wrap: wrap;\n                                gap: 5px;\n                            }\n                            .category-actions .btn {\n                                flex: 1;\n                                min-width: 100px;\n                                text-align: center;\n                                white-space: nowrap;\n                            }\n                            .child-table {\n                                font-size: 13px;\n                            }\n                            .child-table th {\n                                background-color: #f5f7fb;\n                            }\n                            \n                            /* Mobile Optimizations */\n                            @media (max-width: 768px) {\n                                .category-header-content {\n                                    flex-direction: column;\n                                    align-items: flex-start !important;\n                                }\n                                .category-header-right {\n                                    margin-top: 8px;\n                                    width: 100%;\n                                    justify-content: space-between !important;\n                                }\n                                .category-name1 {\n                                    max-width: 100%;\n                                    margin-top: 5px;\n                                }\n                                .category-badge {\n                                    margin: 2px;\n                                }\n                                .category-badges {\n                                    display: flex;\n                                    flex-wrap: wrap;\n                                    margin-top: 5px;\n                                }\n                                .category-actions {\n                                    justify-content: center;\n                                }\n                                .category-collapse-btn {\n                                    position: absolute;\n                                    top: 10px;\n                                    right: 10px;\n                                }\n                                .table-responsive {\n                                    border: 0;\n                                    padding: 0;\n                                }\n                                .child-table {\n                                    font-size: 12px;\n                                }\n                                .child-table th, .child-table td {\n                                    padding: 8px 4px;\n                                }\n                            }\n                            .collapse-icon {\n                                transition: transform 0.3s;\n                            }\n                            .rotate-icon {\n                                transform: rotate(180deg);\n                            }\n                            /* Tối ưu hiệu ứng kéo thả */\n                            .sorting {\n                                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15) !important;\n                                transform: scale(1.01);\n                                transition: transform 0.1s !important;\n                                background-color: rgba(248, 249, 250, 0.9) !important;\n                                z-index: 999;\n                                will-change: transform;\n                            }\n                            #sortable-parent-categories {\n                                min-height: 20px;\n                                will-change: contents;\n                            }\n                            .ui-sortable-helper {\n                                will-change: transform;\n                                transform: translateZ(0); /* Kích hoạt hardware acceleration */\n                                backface-visibility: hidden;\n                                perspective: 1000px;\n                            }\n                            .no-transition {\n                                transition: none !important;\n                            }\n                            .collapse:not(.show) {\n                                display: none !important;\n                            }\n                        </style>\n                        \n                        <div id=\"category-container\">\n                            <ul id=\"sortable-parent-categories\" class=\"list-unstyled mb-0\">\n                                ";
    foreach ($parentCategories as $index => $category) {
        echo "                                <li class=\"sortable-parent-item\" id=\"parent-item-";
        echo $category["id"];
        echo "\" data-id=\"";
        echo $category["id"];
        echo "\">\n                                        <div class=\"card-header p-2 bg-light category-header\">\n                                            <div class=\"d-flex align-items-center justify-content-between w-100 category-header-content\" \n                                                 data-bs-toggle=\"collapse\" data-bs-target=\"#category-";
        echo $category["id"];
        echo "\" \n                                                 aria-expanded=\"false\" aria-controls=\"category-";
        echo $category["id"];
        echo "\" \n                                                 style=\"cursor: pointer;\">\n                                                <div class=\"d-flex align-items-center\">\n                                                    <span class=\"handle-parent\" onclick=\"event.stopPropagation();\">\n                                                        <i class=\"fa-solid fa-grip-vertical\"></i>\n                                                    </span>\n                                                    <img src=\"";
        echo base_url($category["icon"]);
        echo "\" class=\"me-2 rounded\" width=\"36px\" height=\"36px\">\n                                                    <h5 class=\"category-name1\">";
        echo $category["name"];
        echo "</h5>\n                                                </div>\n                                                <div class=\"d-flex align-items-center flex-wrap category-header-right\">\n                                                    <div class=\"category-badges\">\n                                                        <span class=\"badge bg-primary rounded-pill me-1 category-badge\">\n                                                            <i class=\"fa-solid fa-folder me-1\"></i>";
        echo format_cash($CMSNT->num_rows("SELECT * FROM `categories` WHERE `parent_id` = '" . $category["id"] . "'"));
        echo " \n                                                        </span>\n                                                        <span class=\"badge bg-info rounded-pill me-1 category-badge\">\n                                                            <i class=\"fa-solid fa-sort-numeric-up me-1\"></i>";
        echo $category["stt"];
        echo "                                                            <input type=\"hidden\" id=\"stt";
        echo $category["id"];
        echo "\" value=\"";
        echo $category["stt"];
        echo "\">\n                                                        </span>\n                                                        ";
        if($category["status"] == 1) {
            echo "                                                        <span class=\"badge bg-success me-1 category-badge\"><i class=\"fa-solid fa-check me-1\"></i>Hiển thị</span>\n                                                        ";
        } else {
            echo "                                                        <span class=\"badge bg-danger me-1 category-badge\"><i class=\"fa-solid fa-ban me-1\"></i>Ẩn</span>\n                                                        ";
        }
        echo "                                                    </div>\n                                                    <button class=\"btn btn-sm btn-light category-collapse-btn\" type=\"button\" onclick=\"event.stopPropagation();\">\n                                                        <i class=\"fa-solid fa-chevron-down collapse-icon\" data-category-id=\"";
        echo $category["id"];
        echo "\"></i>\n                                                    </button>\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div id=\"category-";
        echo $category["id"];
        echo "\" class=\"collapse\">\n                                            <div class=\"card-body\">\n                                                <div class=\"category-actions\">\n                                                    <a href=\"";
        echo base_url_admin("category-add&id=" . $category["id"]);
        echo "\" class=\"btn btn-sm btn-outline-primary\">\n                                                        <i class=\"fa-solid fa-plus me-1\"></i> Thêm con\n                                                    </a>\n                                                    <a href=\"";
        echo base_url_admin("category-edit&id=" . $category["id"]);
        echo "\" class=\"btn btn-sm btn-outline-info\">\n                                                        <i class=\"fa-solid fa-edit me-1\"></i> Sửa\n                                                    </a>\n                                                    <button onclick=\"RemoveRow('";
        echo $category["id"];
        echo "')\" class=\"btn btn-sm btn-outline-danger\">\n                                                        <i class=\"fa-solid fa-trash me-1\"></i> Xóa\n                                                    </button>\n                                                </div>\n                                                \n                                                ";
        $childCategories = $CMSNT->get_list("SELECT * FROM `categories` WHERE `parent_id` = '" . $category["id"] . "' ORDER BY `stt` DESC");
        echo "                                                \n                                                ";
        if(0 < count($childCategories)) {
            echo "                                                <div class=\"table-responsive mt-3\">\n                                                    <table class=\"table table-striped table-hover border child-table\">\n                                                        <thead>\n                                                            <tr>\n                                                                <th width=\"5%\" class=\"text-center\">\n                                                                    Ưu tiên\n                                                                </th>\n                                                                <th width=\"55%\">Tên</th>\n                                                                <th width=\"10%\">Ảnh</th>\n                                                                <th width=\"10%\">Sản phẩm</th>\n                                                                <th width=\"10%\">Trạng thái</th>\n                                                                <th width=\"10%\">Thao tác</th>\n                                                            </tr>\n                                                        </thead>\n                                                        <tbody>\n                                                            ";
            foreach ($childCategories as $child) {
                echo "                                                            <tr id=\"child-item-";
                echo $child["id"];
                echo "\">\n                                                                <td>\n                                                                    <div class=\"d-flex align-items-center\">\n                                                                        <input type=\"number\" class=\"form-control form-control-sm\" style=\"width: 60px;\" \n                                                                               id=\"stt";
                echo $child["id"];
                echo "\" \n                                                                               value=\"";
                echo $child["stt"];
                echo "\" \n                                                                               onchange=\"updateForm('";
                echo $child["id"];
                echo "')\">\n                                                                    </div>\n                                                                </td>\n                                                                <td>\n                                                                    <span class=\"fw-medium d-block\">";
                echo $child["name"];
                echo "</span>\n                                                                </td>\n                                                                <td>\n                                                                    <img src=\"";
                echo base_url($child["icon"]);
                echo "\" width=\"32px\" height=\"32px\" class=\"img-thumbnail\">\n                                                                </td>\n                                                                <td>\n                                                                    <span class=\"badge bg-primary rounded-pill\">\n                                                                        ";
                echo format_cash($CMSNT->num_rows("SELECT * FROM `products` WHERE `category_id` = '" . $child["id"] . "'"));
                echo "                                                                    </span>\n                                                                </td>\n                                                                <td>\n                                                                    <div class=\"form-check form-switch\">\n                                                                        <input class=\"form-check-input\" type=\"checkbox\"\n                                                                            id=\"status";
                echo $child["id"];
                echo "\" value=\"1\"\n                                                                            ";
                echo $child["status"] == 1 ? "checked" : "";
                echo "                                                                            onchange=\"updateForm('";
                echo $child["id"];
                echo "')\">\n                                                                    </div>\n                                                                </td>\n                                                                <td>\n                                                                    <div class=\"btn-group\" role=\"group\">\n                                                                        <a href=\"";
                echo base_url_admin("category-edit&id=" . $child["id"]);
                echo "\"\n                                                                            class=\"btn btn-sm btn-info\" data-bs-toggle=\"tooltip\" title=\"Sửa\">\n                                                                            <i class=\"fa-solid fa-edit\"></i>\n                                                                        </a>\n                                                                        <button onclick=\"RemoveRow('";
                echo $child["id"];
                echo "')\"\n                                                                            class=\"btn btn-sm btn-danger\" data-bs-toggle=\"tooltip\" title=\"Xóa\">\n                                                                            <i class=\"fa-solid fa-trash\"></i>\n                                                                        </button>\n                                                                    </div>\n                                                                </td>\n                                                            </tr>\n                                                            ";
            }
            echo "                                                        </tbody>\n                                                    </table>\n                                                </div>\n                                                ";
        } else {
            echo "                                                <div class=\"alert alert-info mt-3\">\n                                                    <i class=\"fa-solid fa-info-circle me-2\"></i> Chưa có chuyên mục con nào trong chuyên mục này.\n                                                </div>\n                                                ";
        }
        echo "                                                \n                                                ";
        if(0 < count($childCategories)) {
            echo "                                                <div class=\"alert alert-light border mt-3 fs-sm\">\n                                                    <i class=\"fa-solid fa-info-circle me-2 text-primary\"></i> \n                                                    Ưu tiên càng cao, chuyên mục con càng hiển thị trên cùng.\n                                                </div>\n                                                ";
        }
        echo "                                            </div>\n                                        </div> \n                                </li>\n                                ";
    }
    echo "                            </ul>\n                        </div>\n                        ";
} else {
    echo "                        <div class=\"alert alert-warning\">\n                            <i class=\"fa-solid fa-exclamation-circle me-2\"></i> Chưa có chuyên mục nào trong hệ thống.\n                        </div>\n                        ";
}
echo "                        \n                        <div class=\"alert alert-info mb-2\">\n                            <i class=\"fa-solid fa-info-circle me-2\"></i> \n                            Bạn có thể kéo thả các chuyên mục cha để sắp xếp thứ tự. Nhấp vào biểu tượng <i class=\"fa-solid fa-grip-vertical\"></i> và kéo thả để thay đổi vị trí.\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n\n";
require_once __DIR__ . "/footer.php";
echo "\n<script>\nfunction updateForm(id) {\n    \$.ajax({\n        url: \"";
echo BASE_URL("ajaxs/admin/update.php");
echo "\",\n        method: \"POST\",\n        dataType: \"JSON\",\n        data: {\n            action: 'updateTableCategory',\n            id: id,\n            stt: \$('#stt' + id).val(),\n            status: \$('#status' + id + ':checked').val()\n        },\n        success: function(result) {\n            if (result.status == 'success') {\n                showMessage(result.msg, result.status);\n            } else {\n                showMessage(result.msg, result.status);\n            }\n        },\n        error: function() {\n            alert(html(result));\n            location.reload();\n        }\n    });\n}\n\nfunction updateParentCategoryOrder(order) {\n    // Sử dụng debounce để tránh gửi quá nhiều yêu cầu\n    debounce(function() {\n        \$.ajax({\n            url: \"";
echo BASE_URL("ajaxs/admin/update.php");
echo "\",\n            method: \"POST\",\n            dataType: \"JSON\",\n            data: {\n                action: 'updateCategorySTT',\n                order: order\n            },\n            success: function(result) {\n                if (result.status == 'success') {\n                    showMessage(result.msg, result.status);\n                } else {\n                    showMessage(result.msg, result.status);\n                }\n            },\n            error: function(xhr) {\n                console.error(xhr.responseText);\n                showMessage('Đã xảy ra lỗi khi cập nhật thứ tự', 'error');\n            }\n        });\n    }, 500)();\n}\n\nfunction postRemove(id) {\n    \$.ajax({\n        url: \"";
echo BASE_URL("ajaxs/admin/remove.php");
echo "\",\n        type: 'POST',\n        dataType: \"JSON\",\n        data: {\n            action: 'removeCategory',\n            id: id\n        },\n        success: function(result) {\n            if (result.status == 'success') {\n                showMessage(result.msg, 'success');\n            } else {\n                showMessage(result.msg, 'error');\n            }\n        }\n    });\n}\n\nfunction RemoveRow(id) {\n    cuteAlert({\n        type: \"question\",\n        title: \"";
echo __("Cảnh báo");
echo "\",\n        message: \"Bạn có chắc chắn muốn xóa chuyên mục ID \" + id + \" này không?\",\n        confirmText: \"Đồng ý\",\n        cancelText: \"Hủy\"\n    }).then((e) => {\n        if (e) {\n            postRemove(id);\n            setTimeout(function() {\n                location.reload();\n            }, 1000);\n        }\n    })\n}\n\n// Hàm debounce để giảm số lần gọi hàm\nfunction debounce(func, wait) {\n    let timeout;\n    return function() {\n        const context = this;\n        const args = arguments;\n        clearTimeout(timeout);\n        timeout = setTimeout(function() {\n            func.apply(context, args);\n        }, wait);\n    };\n}\n\n// Xử lý hiển thị/ẩn form thêm chuyên mục cha\ndocument.addEventListener('DOMContentLoaded', function() {\n    const btnAddParent = document.getElementById('btn-add-parent');\n    const btnCloseAddParent = document.getElementById('btn-close-add-parent');\n    const cardAddParent = document.getElementById('card-add-parent');\n\n    btnAddParent.addEventListener('click', function() {\n        cardAddParent.style.display = 'block';\n        // Cuộn trang lên vị trí form\n        cardAddParent.scrollIntoView({behavior: 'smooth'});\n    });\n\n    btnCloseAddParent.addEventListener('click', function() {\n        cardAddParent.style.display = 'none';\n    });\n\n    // Khởi tạo tooltips\n    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\n    tooltipTriggerList.map(function (tooltipTriggerEl) {\n        return new bootstrap.Tooltip(tooltipTriggerEl);\n    });\n});\n\n// Đảm bảo rằng jQuery đã được tải hoàn toàn trước khi thực hiện\n\$(document).ready(function() {\n    console.log('jQuery đã sẵn sàng, khởi tạo kéo thả');\n    \n    // Khởi tạo Sortable cho chuyên mục cha\n    \$('#sortable-parent-categories').sortable({\n        handle: '.handle-parent',\n        items: 'li.sortable-parent-item',\n        axis: 'y',\n        cursor: 'move',\n        opacity: 0.8,\n        placeholder: 'ui-state-highlight',\n        forcePlaceholderSize: true,\n        helper: 'clone',\n        tolerance: 'pointer',\n        delay: 150,\n        scroll: true,\n        scrollSpeed: 5,\n        scrollSensitivity: 50,\n        containment: 'parent',\n        revert: 100,\n        start: function(event, ui) {\n            \$(ui.item).addClass('sorting');\n            // Ẩn nội dung trong quá trình kéo thả để tăng hiệu năng\n            \$(ui.item).find('.collapse').removeClass('show');\n            \$(ui.item).find('.collapse-icon').removeClass('rotate-icon');\n            \n            // Tạm thời vô hiệu hóa các sự kiện click để tăng hiệu năng\n            \$('.collapse').addClass('no-transition');\n            \$('.category-header-content').css('pointer-events', 'none');\n        },\n        stop: function(event, ui) {\n            \$(ui.item).removeClass('sorting');\n            \n            // Khôi phục các sự kiện sau khi kéo thả hoàn tất\n            setTimeout(function() {\n                \$('.collapse').removeClass('no-transition');\n                \$('.category-header-content').css('pointer-events', 'auto');\n            }, 200);\n        },\n        update: function(event, ui) {\n            var parentOrder = [];\n            var total = \$('.sortable-parent-item').length;\n            \n            \$('.sortable-parent-item').each(function() {\n                var id = \$(this).data('id');\n                var position = \$(this).index();\n                \n                // Đảo ngược vị trí để chuyên mục đầu tiên có stt cao nhất\n                var reversedPosition = total - position - 1;\n                \n                parentOrder.push({\n                    id: id,\n                    position: reversedPosition\n                });\n                \n                // Cập nhật giá trị hiển thị\n                \$('#stt' + id).val(reversedPosition + 1);\n            });\n            \n            // Gửi thứ tự mới lên server\n            updateParentCategoryOrder(parentOrder);\n        }\n    }).disableSelection();\n\n    // Cập nhật biểu tượng collapse khi mở/đóng tab\n    \$('.category-header-content').on('click', function() {\n        const categoryId = \$(this).attr('data-bs-target').replace('#category-', '');\n        const icon = \$(this).find('.collapse-icon[data-category-id=\"' + categoryId + '\"]');\n        \n        // Sử dụng setTimeout để đợi hiệu ứng collapse hoàn thành\n        setTimeout(function() {\n            if (\$('#category-' + categoryId).hasClass('show')) {\n                icon.addClass('rotate-icon');\n                // Lưu trạng thái mở vào localStorage, sử dụng debounce để tránh ghi quá nhiều\n                debounce(function() {\n                    localStorage.setItem('last_opened_category', categoryId);\n                }, 300)();\n            } else {\n                icon.removeClass('rotate-icon');\n                // Nếu đóng tab hiện tại và nó là tab được lưu, xóa khỏi localStorage\n                if (localStorage.getItem('last_opened_category') === categoryId) {\n                    localStorage.removeItem('last_opened_category');\n                }\n            }\n        }, 300);\n    });\n    \n    // Khôi phục trạng thái tab đã mở từ localStorage\n    const lastOpenedCategory = localStorage.getItem('last_opened_category');\n    if (lastOpenedCategory) {\n        // Đóng tất cả các tab trước\n        \$('.collapse').removeClass('show');\n        \n        // Mở tab đã lưu \n        \$('#category-' + lastOpenedCategory).addClass('show');\n        \n        // Cập nhật biểu tượng mũi tên\n        \$('.collapse-icon').removeClass('rotate-icon');\n        \$('.collapse-icon[data-category-id=\"' + lastOpenedCategory + '\"]').addClass('rotate-icon');\n    }\n\n    // Xử lý nút đóng tất cả chuyên mục\n    \$('#collapse-all-btn').on('click', function() {\n        \$('.collapse').removeClass('show');\n        \$('.collapse-icon').removeClass('rotate-icon');\n        localStorage.removeItem('last_opened_category');\n    });\n    \n    // Xử lý nút mở tất cả chuyên mục\n    \$('#expand-all-btn').on('click', function() {\n        \$('.collapse').addClass('show');\n        \$('.collapse-icon').addClass('rotate-icon');\n    });\n});\n</script>";

?>